apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  labels:
    {{- include "openops.componentLabels" (dict "root" . "component" "nginx") | nindent 4 }}
data:
  nginx.gateway.conf: |
    {{- if .Values.nginx.rateLimiting.enabled }}
    # Rate limiting zones
    limit_req_zone $binary_remote_addr zone={{ .Values.nginx.rateLimiting.zone }} rate={{ .Values.nginx.rateLimiting.rate }};
    limit_conn_zone $binary_remote_addr zone={{ .Values.nginx.rateLimiting.connZone }};
    {{- end }}

    server {
        listen 80;
        server_name openops;

        client_max_body_size 10m;
        client_body_buffer_size 128k;
        client_header_buffer_size 1k;
        large_client_header_buffers 4 16k;
        
        # Security headers
        {{- if .Values.nginx.securityHeaders.enabled }}
        add_header X-Content-Type-Options "{{ .Values.nginx.securityHeaders.xContentTypeOptions }}" always;
        add_header X-Frame-Options "{{ .Values.nginx.securityHeaders.xFrameOptions }}" always;
        add_header Content-Security-Policy "{{ .Values.nginx.securityHeaders.contentSecurityPolicy }}" always;
        add_header Permissions-Policy "{{ .Values.nginx.securityHeaders.permissionsPolicy }}" always;
        add_header Referrer-Policy "{{ .Values.nginx.securityHeaders.referrerPolicy }}" always;
        {{- else }}
        add_header Referrer-Policy "no-referrer-when-downgrade";
        {{- end }}
        add_header X-XSS-Protection "1; mode=block" always;
        
        ssi off;
        server_tokens off;

        {{- if .Values.nginx.rateLimiting.enabled }}
        # Apply rate limiting
        limit_req zone={{ (split ":" .Values.nginx.rateLimiting.zone)._0 }} burst={{ .Values.nginx.rateLimiting.burst }} nodelay;
        limit_conn {{ (split ":" .Values.nginx.rateLimiting.connZone)._0 }} {{ .Values.nginx.rateLimiting.connLimit }};
        {{- end }}

        location / {
            proxy_pass {{ include "openops.appServiceUrl" . }};
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # --- AI Streaming-specific settings ---
            proxy_buffering off;
            proxy_cache off;
            chunked_transfer_encoding on;
        }

        location /api/socket.io {
            proxy_pass {{ include "openops.appServiceUrl" . }}/socket.io;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /openops-analytics {
            proxy_pass {{ include "openops.analyticsServiceUrl" . }};
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /openops-tables/ws/core {
            proxy_pass {{ include "openops.tablesServiceUrl" . }}/openops-tables/ws/core;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /openops-tables {
            client_max_body_size 512m;
            proxy_pass {{ include "openops.tablesServiceUrl" . }};
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
